# ErrorProfiler
for manuscript "Characterization of sequencing error profile in three next generation sequencing platforms"

## simple tutorial

let's say you have already mapped your paired fastq files on reference genome, and get a sam file called "aligned.sam"

#### Step0 Mark duplicates (optional)

You can use any your favorite tools to do this job such as picard, sambamba, gencore etc.

#### Step1 Cleanse your sam file

To remove any “trash reads” to make results more accurate use following command:


> samtools view -@ <threads> -h -f 3 -F 3852 -o filtered.sam aligned.sam


#### Step2 Sort your sam file

Overlapping consistency assessment needs two files: query name sorted sam file and a sorted bam file. So use following commands to do the job.

> samtools sort -n -@ <threads> -o queryname.sam filtered.sam
> 
> samtools sort @ <threads> -o sorted.bam filtered.sam
> 
> samtools index @ <threads> sorted.bam


#### Step3 Filter according to overlap length

Fail to do this step will lead to an overestimated error rate and bias since the most of the sequencing error occurs at the end of the reads.

> ./filter_overlap_length.py queryname.sam <length_cutoff>


Ideally you should use read length as length_cutoff (e.g. filter\_overlap\_length.py queryname.sam 150) However a solid consistency assessment may need about 1M read pair use read length will discard too many data. Therefore probably you should use a smaller cutoff such as 148, 145 or even 140 as length_cutoff

#### Step4 Bin the base calls

Collect the base calls in the overlapped region

> ./noise.py -b sorted.bam -l 99999 queryname_<length_cutoff>.sam


queryname_<length_cutoff>.sam is the output of previous step. “-l 99999” is a historic problem that I have no time to fix. This step will produce a raw bin file (.rawbin.txt)
Note: Due to my poor programming this step may use about 200G memory.

#### Step5 Visualization

Do the statistics and visualization
> ./plot.R <rawbin.txt> <sample_name>

replace <rawbin.txt> with the actual file generated by last step.Use a meaningful and unique string as <sample_name> since it will be used as the prefix of output files.

Note: This R script needs the following packages: stringr, stringi, ggplot2, tidyverse, magrittr, ggrepel


#### Step6 Overall mismatch statistics (Optional)

The script filter\_overlap\_length_group_2.py is not the part of ErrorProfiler pipeline however it helps you understand where overall mismatches locate in a template. It uses CIGAR string and MD tags to locate position

> ./filter_overlap_length_group_2.py queryname.sam

It will output how many mismatches and bases in each location in a template.
